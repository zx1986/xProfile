#!/bin/sh
set -e

{{ if eq .chezmoi.os "darwin" -}}
# === macOS: Install via Homebrew ===
if ! command -v brew >/dev/null; then
  echo "Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
fi

echo "Installing Brew Packages..."
brew install git tig bit-git curl asdf zsh coreutils

# ASDF Setup (macOS)
if [ -f "$(brew --prefix asdf)/asdf.sh" ]; then
    . "$(brew --prefix asdf)/asdf.sh"
fi

asdf plugin add golang || true
asdf plugin add ruby || true
asdf plugin add python || true
asdf plugin add nodejs || true
asdf plugin add kubectl || true
asdf plugin add helm || true

if [ -f "$HOME/.tool-versions" ]; then
    echo "Installing ASDF versions..."
    asdf install
fi

{{ else -}}
# === Linux (Ubuntu 22.04): Offline-capable Install ===
# Packages are pre-bundled in $OFFLINE_DIR by prepare_offline_bundle.sh,
# OR installed via apt if internet is available.

OFFLINE_DIR="$HOME/.local/share/offline-packages"

# --- Install core .deb packages (offline bundle) ---
if [ -d "$OFFLINE_DIR/debs" ] && ls "$OFFLINE_DIR/debs/"*.deb >/dev/null 2>&1; then
  echo "Installing core .deb packages from offline bundle..."
  sudo dpkg -i "$OFFLINE_DIR/debs/"*.deb 2>/dev/null || true
  sudo apt-get install -f -y 2>/dev/null || true
elif command -v apt-get >/dev/null; then
  echo "Installing core packages via apt..."
  sudo apt-get update -qq
  sudo apt-get install -y zsh tmux git curl wget unzip build-essential
fi

# --- Install standalone binaries from offline bundle ---
for bin in chezmoi fd fzf eza bat tig; do
  if ! command -v "$bin" >/dev/null && [ -f "$OFFLINE_DIR/bin/$bin" ]; then
    echo "Installing $bin from offline bundle..."
    sudo install -m 755 "$OFFLINE_DIR/bin/$bin" /usr/local/bin/"$bin"
  fi
done

# --- Install asdf ---
if ! command -v asdf >/dev/null; then
  # Try offline bundle first
  ASDF_TGZ=$(ls "$OFFLINE_DIR/asdf/"*.tar.gz 2>/dev/null | head -1 || true)
  if [ -n "$ASDF_TGZ" ]; then
    echo "Installing asdf from offline bundle..."
    tar xzf "$ASDF_TGZ" -C "$HOME/.local/bin/" asdf 2>/dev/null \
      || tar xzf "$ASDF_TGZ" -C /tmp && sudo install -m 755 /tmp/asdf /usr/local/bin/asdf
  elif command -v git >/dev/null; then
    echo "Installing asdf from GitHub..."
    ASDF_VERSION=$(curl -fsS https://api.github.com/repos/asdf-vm/asdf/releases/latest \
      | grep '"tag_name"' | cut -d'"' -f4)
    git clone --depth=1 --branch "${ASDF_VERSION}" \
      https://github.com/asdf-vm/asdf.git "$HOME/.asdf"
  fi
fi

{{ end -}}
